<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>二酸化炭素排出量可視化システム</title>
    <script src="../static/js/echarts.js"></script>
    <script type="text/javascript" src="../static/js/jquery.js"></script>
    <link rel="stylesheet" href="../static/css/comon0.css">

</head>
<body>
    <div class="loading">
        <div class="loadbox"> <img src="../static/images/loading.gif"> Loading.. </div>
    </div>

    <div class="head">
  <h1>二酸化炭素排出量可視化システム</h1>
  <div class="time" id="showTime">2022/10/01 00:00:00</div>

<script>
var t = null;
    t = setTimeout(time,1000);//開始运行
    function time()
    {
       clearTimeout(t);//清除定时器
       dt = new Date();
		var y=dt.getFullYear();
		var mt=dt.getMonth()+1;
		var day=dt.getDate();
       var h=dt.getHours();//获取时
       var m=dt.getMinutes();//获取分
       var s=dt.getSeconds();//获取秒
		var t = null;
       document.getElementById("showTime").innerHTML = y+"/"+Appendzero(mt)+"/"+Appendzero(day)+" "+Appendzero(h)+":"+Appendzero(m)+":"+Appendzero(s)+"";
        function Appendzero(obj){
			if(obj<10) return "0" +""+ obj;
			else return obj;
		 }
		t = setTimeout(time,1000); //设定定时器，循环运行
    }
</script>
    </div>

    <div class="mainbox">

  <ul class="clearfix">
    <li>

	  <div class="boxall" style="height: calc(58% - .15rem)">
		<div class="alltitle">1分間二酸化炭素排出量ランキング</div>
		 <div class=" boxnav " id="echarts4">
        </div>
      </div>
      <div class="boxall" style="height: calc(42% - .15rem)">
          <div class="alltitle">1日二酸化炭素排出量変化</div>
          <div class="boxnav" id="echarts3"></div>
        </div>
    </li>
    <li>
        <div class="boxall" style="height: calc(20% - .15rem)">
          <div class="alltitle">本日二酸化炭素排出量総量</div>
          <div class="boxnav" id="echarts7"></div>
        </div>
          <div class="boxall" style="height: calc(38% - .15rem)">
            <div class="alltitle">リアルタイム二酸化炭素排出量(g)</div>
              <div class="boxnav" id="echarts1"></div>
            </div>
            <div class="boxall" style="height: calc(42% - .15rem)">
              <div class="alltitle">リアルタイム電気使用量(w)</div>
                <div class="boxnav" id="echarts2"></div>
              </div>

    </li>
    <li>

		<div class="boxall" style="height: calc(33.333% - .15rem)">

			<div class="alltitle">年間総量変化</div>
			<div class="boxnav" id="echarts5"></div>

      </div>
      <div class="boxall" style="height: calc(33.333% - .15rem)">
        <div class="alltitle">注目項目</div>
		<div class="boxnav" id="">
<table border="0" cellspacing="0">
  <tr>
    <th></th>
    <th>排出量(単位:t)</th>
    <th>総量比</th>
    <th>増長量(単位:t)</th>
    <th>増長率</th>

  </tr>
  <tr>
    <th>項目1</th>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <th>項目2</th>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <th>項目3</th>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <th>項目4</th>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
</table>


    </div>

	  </div>
	  <div class="boxall" style="height: calc(33.333% - .15rem)">
        <div class="alltitle">全体比率</div>
		<div class="boxnav" id="echarts6" style="height:calc(100% - .3rem);"></div>
      </div>
    </li>
  </ul>
</div>

<!-- 模态框结构 -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Option</h5>
    </div>
    <div class="modal-body">
      <!-- 模态框内容 -->
      <div class="settings-main">
        <label>Main: <input type="text" id="mainInput" /></label>
      </div>
      <div class="settings-container">        
        <div class="settings-side settings-left">
          <!-- 左侧输入框 1-8 -->
        </div>
        <img src="../static/images/emporiaVue.jpg" alt="示例图片" class="settings-image" />
        <div class="settings-side settings-right">
          <!-- 右侧输入框 9-16 -->
        </div>
      </div>
      <div class="settings-matome">
        <!-- まとめ输入框 -->
      </div>
    </div>
    <div class="modal-footer">
      <!--<button class="button" id="cancelButton">close</button>-->
      <button class="button" id="saveChanges">save</button>
    </div>
  </div>
</div>

<!-- 弹窗部分 -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="modalChart" style="width: 600px; height: 400px;"></div>
  </div>
</div>

<!-- 设置按钮 -->
<button id="settingsButton" class="settings-button">Option</button>

<script>
  function echarts_1(data) {
    // 获取当前时间
    var currentTime = new Date();

    // 过滤一分钟以内的数据
    var filteredMinuteData = data.second.filter(function (item) {
      var itemTime = new Date(item.time);
      var timeDifference = currentTime - itemTime;
      return timeDifference <= 60000; // 60000 毫秒 = 1 分钟
    });

    // 获取项目名称，排除 "balance"
    var names = data.second.reduce(function (names, item) {
      if (names.indexOf(item.name) === -1 && item.name !== "Balance") {
        names.push(item.name);
      }
      return names;
    }, []);

    // 过滤掉名为 "balance" 的数据
    filteredMinuteData = filteredMinuteData.filter(function (item) {
      return item.name !== "Balance";
    });

    // 准备项目数据
    var seriesData = names.map(function (name) {
      return {
        name: getNewName(name),
        type: 'line',
        data: filteredMinuteData
          .filter(function (item) {
            return item.name === name;
          })
          .map(function (item) {
            return [item.time, item.number / 3600 * 0.433];
          }),
      };
    });

    // 初始化 ECharts 实例
    var myChart = echarts.init(document.getElementById('echarts1'));

    // 指定图表的配置项和数据
    var option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow',
      },
    },
    grid: {
      left: '0',
      top: '30',
      right: '10',
      bottom: '-20',
      containLabel: true,
    },
    legend: {
      data: names.map(function (name) {
        return getNewName(name);
      }),
      right: 'center',
      top: 0,
      textStyle: {
        color: '#fff',
      },
      itemWidth: 12,
      itemHeight: 10,
    },
    xAxis: {
      type: 'time',
      boundaryGap: false,
      axisLabel: {
        rotate: -90,
        textStyle: {
          color: 'rgba(255,255,255,.6)',
          fontSize: 14,
        },
        interval: function (index, value) {
          return index % (Math.ceil(filteredMinuteData.length / 6)) === 0;
        },
      },
      axisLine: {
        lineStyle: {
          color: 'rgba(255,255,255,.1)',
        },
      },
      min: currentTime - 60000,
      max: currentTime,
      splitNumber: 5,
    },
    yAxis: {
      type: 'value',
      axisTick: { show: false },
      axisLine: {
        lineStyle: {
          color: 'rgba(255,255,255,.1)',
        },
      },
      axisLabel: {
        textStyle: {
          color: 'rgba(255,255,255,.6)',
          fontSize: 14,
        },
        formatter: function (value) {
          return value + 'g';
        }
      },
      splitLine: {
        lineStyle: {
          color: 'rgba(255,255,255,.1)',
        },
      },
    },
    series: seriesData.map(function (seriesItem, index) {
      // 根据您提供的样式，您可以修改此处的颜色、区域样式、线条样式等。
      // 以下是一个示例，根据项目数量设置不同的颜色。
      var colors = [
        '#3B7DF8', // 蓝色
        '#F44336', // 红色
        '#4CAF50', // 绿色
        '#FF9800', // 橙色
        '#9C27B0', // 紫色
        '#00BCD4', // 青色
        '#FFEB3B', // 黄色
        '#795548', // 棕色
        '#607D8B'  // 蓝灰色
      ];
      var color = colors[index % colors.length];

      return {
        name: seriesItem.name,
        type: 'line',
        smooth: true,
        symbol: 'circle',
        symbolSize: 5,
        showSymbol: false,
        lineStyle: {
          normal: {
            color: color,
            width: 2,
          },
        },
        itemStyle: {
          normal: {
            color: color,
            borderColor: echarts.color.lift(color, 0.1),
            borderWidth: 12,
          },
        },
        data: seriesItem.data,
      };
    }),
    };
    // 使用刚指定的配置项和数据显示图表
    myChart.setOption(option);
    window.addEventListener('resize', function () {
      myChart.resize();
    });
  }

  function echarts_2(data) {
    // 获取当前时间
    var currentTime = new Date();

    // 过滤一分钟以内的数据
    var filteredMinuteData = data.second.filter(function (item) {
      var itemTime = new Date(item.time);
      var timeDifference = currentTime - itemTime;
      return timeDifference <= 60000; // 60000 毫秒 = 1 分钟
    });

    // 获取项目名称，排除 "balance"
    var names = data.second.reduce(function (names, item) {
      if (names.indexOf(item.name) === -1 && item.name !== "Balance") {
        names.push(item.name);
      }
      return names;
    }, []);

    // 过滤掉名为 "balance" 的数据
    filteredMinuteData = filteredMinuteData.filter(function (item) {
      return item.name !== "Balance";
    });

    // 准备项目数据
    var seriesData = names.map(function (name) {
      return {
        name: getNewName(name),
        type: 'line',
        data: filteredMinuteData
          .filter(function (item) {
            return item.name === name;
          })
          .map(function (item) {
            return [item.time, item.number];
          }),
      };
    });

    // 初始化 ECharts 实例
  var myChart = echarts.init(document.getElementById('echarts2'));

  // 指定图表的配置项和数据
  var option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow',
      },
    },
    grid: {
      left: '0',
      top: '30',
      right: '10',
      bottom: '-20',
      containLabel: true,
    },
    legend: {
      data: names.map(function (name) {
        return getNewName(name);
      }),
      right: 'center',
      top: 0,
      textStyle: {
        color: '#fff',
      },
      itemWidth: 12,
      itemHeight: 10,
    },
    xAxis: {
      type: 'time',
      boundaryGap: false,
      axisLabel: {
        rotate: -90,
        textStyle: {
          color: 'rgba(255,255,255,.6)',
          fontSize: 14,
        },
        interval: function (index, value) {
          return index % (Math.ceil(filteredMinuteData.length / 6)) === 0;
        },
      },
      axisLine: {
        lineStyle: {
          color: 'rgba(255,255,255,.1)',
        },
      },
      min: currentTime - 60000,
      max: currentTime,
      splitNumber: 5,
    },
    yAxis: {
      type: 'value',
      axisTick: { show: false },
      axisLine: {
        lineStyle: {
          color: 'rgba(255,255,255,.1)',
        },
      },
      axisLabel: {
        textStyle: {
          color: 'rgba(255,255,255,.6)',
          fontSize: 14,
        },
        formatter: function (value) {
          return value + 'w';
        }
      },
      splitLine: {
        lineStyle: {
          color: 'rgba(255,255,255,.1)',
        },
      },
    },
    series: seriesData.map(function (seriesItem, index) {
      // 根据您提供的样式，您可以修改此处的颜色、区域样式、线条样式等。
      // 以下是一个示例，根据项目数量设置不同的颜色。
      var colors = [
        '#3B7DF8', // 蓝色
        '#F44336', // 红色
        '#4CAF50', // 绿色
        '#FF9800', // 橙色
        '#9C27B0', // 紫色
        '#00BCD4', // 青色
        '#FFEB3B', // 黄色
        '#795548', // 棕色
        '#607D8B'  // 蓝灰色
      ];
      var color = colors[index % colors.length];

      return {
        name: seriesItem.name,
        type: 'line',
        smooth: true,
        symbol: 'circle',
        symbolSize: 5,
        showSymbol: false,
        lineStyle: {
          normal: {
            color: color,
            width: 2,
          },
        },
        itemStyle: {
          normal: {
            color: color,
            borderColor: echarts.color.lift(color, 0.1),
            borderWidth: 12,
          },
        },
        data: seriesItem.data,
      };
    }),
    };
    // 使用刚指定的配置项和数据显示图表
    myChart.setOption(option);
    window.addEventListener('resize', function () {
      myChart.resize();
    });
  }

  function echarts_3(data) {
      // ... 使用 data 更新 echarts2
  }

  function echarts_4(data) {
    // 定义 colors 变量
    var colors = [
      "#c23531",
      "#2f4554",
      "#61a0a8",
      "#d48265",
      "#91c7ae",
      "#749f83",
      "#ca8622",
      "#bda29a",
      "#6e7074",
      "#546570",
      "#c4ccd3",
    ];

    // 对数据按时间排序（降序）
    data.minute.sort(function (a, b) {
      return new Date(b.time) - new Date(a.time);
    });

    // 获取最新时间
    var latestTime = data.minute[0].time;

    // 选择与最新时间相同的数据
    var latestData = data.minute.filter(function (item) {
      return item.time === latestTime;
    });

    // 按照 number 降序排列数据
    latestData.sort(function (a, b) {
      return b.number - a.number;
    });

    // 只保留 number 最大的 9 个项目
    var topData = latestData.slice(0, 9);

    // 获取项目名称和 number 数组
    var names = topData.map(function(item) {
        return getNewName(item.name);
    });

    var numbers = topData.map(function(item) {
        return item.number;
    });

    // 初始化 ECharts 实例
    var myChart = echarts.init(document.getElementById('echarts4'));

    // 指定图表的配置项和数据
    var option = {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
          left: '0',
          top: '20',
          right: '10',
          bottom: '-20',
          containLabel: true,
        },
        xAxis: {
            type: 'value',
            boundaryGap: [0, 0.01],
            axisLabel: {
              formatter: function (value) {
                return value + 'g';
              }
            }
        },
        yAxis: {
            type: 'category',
            data: names.reverse()
        },
        series: [
            {
                name: '二酸化炭素排出量(g)',
                type: 'bar',
                data: numbers.map(function(item) { return item / 60 * 0.433; }).reverse(),
                itemStyle: {
                  emphasis: {
                    color: function (params) {
                      return colors[params.dataIndex];
                    },
                  },
                },
                emphasis: {
                  focus: 'series',
                },
            }
        ]
    };

    // 使用刚指定的配置项和数据显示图表
    myChart.setOption(option);
    window.addEventListener('resize', function () {
      myChart.resize();
    });

    // 弹窗关闭相关代码
    var modal = document.getElementById("myModal");
    var closeButton = document.getElementsByClassName("close")[0];

    closeButton.onclick = function () {
      modal.style.display = "none";
    };

    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };

    // ECharts 相关代码
    var modalChart = echarts.init(document.getElementById("modalChart"));

    // 在 echarts_4 函数中添加点击事件处理
    option.series[0].emphasis = {
      focus: "series",
    };

    myChart.on('click', function (params) {
      // 获取选中项目的名字
      var selectedItemName = params.name;

      // 筛选与选中项目相关的数据
      var startTime = new Date() - 5 * 60 * 1000; // 10分钟之前的时间戳
      var timeRange = [];

      for (var i = 0; i < 5 * 60; i++) { // 10分钟的秒数
        timeRange.push(new Date(startTime + i * 1000)); // 将每一秒的时间戳添加到timeRange数组中
      }
      selectedItemData = timeRange.map(function (time) {
        var existingData = data.second.find(function (item) {
            var rangeTime = time.getTime();
            var itemTime = new Date(item.time).getTime();
            return getNewName(item.name) === selectedItemName && Math.abs(itemTime  - rangeTime) < 1000;
          });

        if (existingData) {
          return existingData;
        } else {
          return { name: selectedItemName, time: time, number: 0 };
        }
      });

      // 准备数据
      var xAxisData = selectedItemData.map(function (item) {
        return new Date(item.time).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      });

      var yAxisData = selectedItemData.map(function (item) {
        return (item.number / 3600) * 0.433;
      });

      // 定义 modalOption
      var modalOption = {
        title: {
          text: '5分間の秒ごと変化図',
          left: 'center'
        },
        tooltip: {
          trigger: 'axis'
        },
        xAxis: {
          type: 'category',
          data: xAxisData,
          axisLabel: {
            interval: function (index, value) {
              return index % 30 === 0;
            }
          }
        },
        yAxis: {
          type: 'value',
          axisLabel: {
            formatter: function (value) {
              return value + 'g';
            }
          }
        },
        series: [
          {
            data: yAxisData,
            type: 'line',
            smooth: true,
            areaStyle: {}
          }
        ]
      };
      // 创建弹出窗口
      var modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = "popup";
      if (document.getElementById("popup")) {
        document.getElementById("popup").remove();
      }
      document.body.appendChild(modal);

      var modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.id = 'modal-content';
      modal.appendChild(modalContent);

      var closeButton = document.createElement('span');
      closeButton.className = 'close';
      closeButton.innerHTML = '&times;';
      modalContent.appendChild(closeButton);

      closeButton.addEventListener('click', function () {
        modal.style.display = 'none';
      });

      // 在弹出窗口中添加图表
      var chartContainer = document.createElement('div');
      chartContainer.style.width = 'calc(100% - 20px)';
      chartContainer.style.height = 'calc(100% - 40px)';
      modalContent.appendChild(chartContainer);

      // 将弹出窗口添加到页面中
      document.body.appendChild(modal);

      // 初始化图表并设置数据
      var newChart = echarts.init(chartContainer);
      setTimeout(function () {
        newChart.setOption(modalOption);
        var modalContent = document.getElementById('modal-content');
        chartContainer.style.width = window.getComputedStyle(modalContent).width + ' - 20px)';
        chartContainer.style.height = 'calc(' + window.getComputedStyle(modalContent).height + ' - 40px)';
        newChart.resize();

        window.addEventListener("resize", function () {
          chartContainer.style.width = window.getComputedStyle(modalContent).width + ' - 20px)';
          chartContainer.style.height = 'calc(' + window.getComputedStyle(modalContent).height + ' - 40px)';
          newChart.resize();
        });
      }, 0);

      // 显示模态窗口
      modal.style.display = 'block';
    });
  }

  function echarts_5(data) {
      // ... 使用 data 更新 echarts2
  }
  
  function echarts_6(data) {
      // ... 使用 data 更新 echarts2
  }

  function echarts_7(data) {
      // ... 使用 data 更新 echarts2
  }

  // ... 其他图表函数

  // 更新图表数据的函数
  function updateChartData() {
    // 发起 AJAX 请求以获取新数据
    $.getJSON('/get_saved_data', function (response) {
        var data = response.data;

        // 使用新数据更新图表
        echarts_1(data);
        echarts_2(data);
        echarts_3(data);
        echarts_4(data);
        echarts_5(data);
        echarts_6(data);
        echarts_7(data);

        // 1秒后再次更新数据
        setTimeout(updateChartData, 1000);
    });
  }



  // 页面加载完成时，隐藏 loading 动画
  $(window).load(function() {
      $(".loading").fadeOut();
  });

  // 设置字体大小
  $(document).ready(function() {
      var whei = $(window).width();
      $("html").css({ fontSize: whei / 20 });
      $(window).resize(function() {
          var whei = $(window).width();
          $("html").css({ fontSize: whei / 20 });
      });
  });

// 用于存储新名称数据的全局变量
var newNameData = [];

// 从 JSON 文件中加载新名称数据
function loadNewNameData() {
  $.getJSON("../static/datas/newname.json", function (data) {
    newNameData = data;
    console.log("New name data loaded:", newNameData); // 添加此行以检查数据
  });
}

// 调用函数加载新名称数据
loadNewNameData();

function getNewName(projectName) {
  for (var i = 0; i < newNameData.length; i++) {
    if (newNameData[i].name === projectName) {
      return newNameData[i].newname;
    }
  }
  // 如果找不到对应的新名称，返回原始名称
  return projectName;
}

// 创建输入框
function createInput(id) {
  const input = document.createElement("input");
  input.type = "text";
  input.id = id;
  return input;
}

// 创建左侧输入框
const leftInputs = document.querySelector(".settings-left");
for (let i = 1; i <= 8; i++) {
  const label = document.createElement("label");
  label.textContent = `${i}: `;
  label.style.color = "black"; // 添加这行
  const input = createInput(`input${i}`);
  label.appendChild(input);
  leftInputs.appendChild(label);
}

// 创建右侧输入框
const rightInputs = document.querySelector(".settings-right");
for (let i = 9; i <= 16; i++) {
  const label = document.createElement("label");
  label.textContent = `${i}: `;
  label.style.color = "black"; // 添加这行
  const input = createInput(`input${i}`);
  label.appendChild(input);
  rightInputs.appendChild(label);
}

// 创建まとめ输入框
const matomeContainer = document.querySelector(".settings-matome");
for (let i = 1; i <= 5; i++) {
  const label = document.createElement("label");
  label.textContent = `まとめ${i}: `;
  label.style.color = "black"; // 添加这行
  const input = createInput(`matomeInput${i}`);
  label.appendChild(input);
  matomeContainer.appendChild(label);
}

// 读取和保存 newname.json 和 matome.json 的函数
async function fetchJson(url) {
  const response = await fetch(url);
  const data = await response.json();
  return data;
}

async function saveJson(url, data) {
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  });

  return await response.json();
}

// 初始化输入框内容
async function initializeInputs() {
  const newnameData = await fetchJson("../static/datas/newname.json");
  const matomeData = await fetchJson("../static/datas/matome.json");

  // 将名字与新名字匹配
  function getNewName(name) {
    const matchedItem = newnameData.find(item => item.name === name);
    return matchedItem ? matchedItem.newname : "";
  }

  // 将名字与matome名字匹配
  function getMatomeName(name) {
    const matchedItem = matomeData.find(item => item.name === name);
    return matchedItem ? matchedItem.newname : "";
  }

  document.getElementById("mainInput").value = getNewName("Main");

  for (let i = 1; i <= 16; i++) {
    document.getElementById(`input${i}`).value = getNewName(i.toString());
  }

  for (let i = 1; i <= 5; i++) {
    document.getElementById(`matomeInput${i}`).value = getMatomeName(`まとめ${i}`);
  }
}

initializeInputs();

// 保存按钮点击事件
document.getElementById("saveChanges").addEventListener("click", async function () {
  const newnameData = [];
  const matomeData = [];

  newnameData.push({ name: 'Main', newname: document.getElementById("mainInput").value });

  for (let i = 1; i <= 16; i++) {
    newnameData.push({ name: i.toString(), newname: document.getElementById(`input${i}`).value });
  }

  for (let i = 1; i <= 5; i++) {
    const matomeItem = {
      name: `matome${i}`,
      newname: document.getElementById(`matomeInput${i}`).value,
      Main: "0",
    };

    for (let j = 1; j <= 16; j++) {
      matomeItem[j.toString()] = "1";
    }

    matomeData.push(matomeItem);
  }

  await saveJson("/update_newname", newnameData);
  await saveJson("/update_matome", matomeData);

  // 调用函数加载新名称数据
  loadNewNameData();

  settingsModal.style.display = "none";
});

document.getElementById("settingsButton").addEventListener("click", function () {
  const settingsModal = document.getElementById("settingsModal");
  settingsModal.style.display = "block";
});

// 点击关闭按钮时关闭模态框
document.getElementsByClassName("close")[0].addEventListener("click", function () {
  const settingsModal = document.getElementById("settingsModal");
  settingsModal.style.display = "none";
});

// 点击模态框外部时关闭模态框
window.addEventListener("click", function (event) {
  const settingsModal = document.getElementById("settingsModal");
  if (event.target === settingsModal) {
    settingsModal.style.display = "none";
  }
});

// 初始化图表并第一次更新数据
updateChartData();

</script>

</body>
</html>
